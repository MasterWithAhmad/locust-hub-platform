<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Settings - ML Project</title>
  <meta name="description" content="User settings page for the ML Project.">
  <meta name="keywords" content="ML, Machine Learning, Prediction, Locust, Settings, Dashboard">

  <link href="assets/img/logo.webp" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <link href="assets/css/main.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* Modern Settings Page Styles */
    :root {
      --primary-color: #4e73df;
      --primary-light: #9bb8ff;
      --secondary-color: #1cc88a;
      --secondary-light: #7ae0b7;
      --warning-color: #f6c23e;
      --warning-light: #f9d78c;
      --info-color: #36b9cc;
      --info-light: #80d6e5;
      --danger-color: #e74a3b;
      --dark-color: #2c3e50;
      --light-color: #f8f9fc;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    body {
      background-color: #f8f9fa;
      color: #4a4a4a;
      margin: 0;
      padding: 0 0 0 250px;
      min-height: 100vh;
    }

    .main-content {
      padding: 1.5rem;
      margin: 0;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .row {
      margin-left: 0;
      margin-right: 0;
    }

    .settings-card {
      margin: 0 0.5rem 1rem 0.5rem;
    }

    .container-fluid {
      padding: 0;
      margin: 0;
      max-width: 100%;
    }

    .row {
      margin: 0;
      --bs-gutter-x: 0;
    }

    .settings-card {
      height: 100%;
      margin-bottom: 0;
    }

    .card-body {
      padding: 1.5rem;
    }

    @media (max-width: 991.98px) {

      /* Sidebar styles */
      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
        padding: 48px 0 0;
        box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        background: linear-gradient(180deg, var(--primary-color) 0%, #3a7bd5 100%);
        width: 250px;
      }

      /* Main content adjustment */
      body {
        margin: 0;
        padding: 0 0 0 250px;
        min-height: 100vh;
        background-color: #f8f9fa;
      }

      .main-content {
        width: 100%;
        padding: 1.5rem;
        margin: 0;
      }

      .container-fluid {
        padding: 0;
        margin: 0;
        max-width: 100%;
      }
    }

    /* Sidebar Styles */
    .sidebar {
      background: linear-gradient(180deg, var(--primary-color) 0%, #224abe 100%) !important;
      min-height: 100vh;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      z-index: 1000;
      padding-top: 1rem;
      overflow-y: auto;
    }

    @media (max-width: 767.98px) {
      .sidebar {
        position: fixed;
        left: -250px;
        transition: all 0.3s;
      }

      .sidebar.show {
        left: 0;
      }
    }

    .sidebar .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 0.75rem 1rem;
      margin: 0.15rem 0.5rem;
      border-radius: 0.35rem;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .sidebar .nav-link:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .sidebar .nav-link.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
      font-weight: 600;
    }

    .sidebar .nav-link i {
      margin-right: 0.5rem;
      font-size: 1rem;
      width: 20px;
      text-align: center;
    }

    .sidebar .nav-link.text-danger {
      color: #fff !important;
    }

    .sidebar .nav-link.text-danger:hover {
      background: rgba(220, 53, 69, 0.2);
    }

    .initials-circle {
      width: 80px;
      height: 80px;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 2rem;
      font-weight: bold;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.5rem auto;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .initials-circle:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    /* Settings Page Specific Styles */
    .settings-header {
      padding: 1.5rem 0;
      margin-bottom: 2rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .settings-header h2 {
      color: var(--dark-color);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .settings-header p {
      color: #6c757d;
      font-size: 1.05rem;
    }

    .settings-card {
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: none;
      margin-bottom: 2rem;
      overflow: hidden;
      transition: var(--transition);
    }

    .settings-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.1) !important;
    }

    .settings-card .card-header {
      background: white;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .settings-card .card-header h6 {
      margin: 0;
      font-weight: 600;
      color: var(--dark-color);
      font-size: 1.1rem;
    }

    .settings-card .card-header i {
      color: var(--primary-color);
      font-size: 1.25rem;
    }

    .settings-card .card-body {
      padding: 1.75rem;
    }

    .profile-info p {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px dashed #eee;
    }

    .profile-info p:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .profile-info strong {
      min-width: 120px;
      display: inline-flex;
      align-items: center;
      color: #6c757d;
    }

    .profile-info i {
      margin-right: 0.75rem;
      color: var(--primary-color);
      width: 20px;
      text-align: center;
    }

    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-control,
    .form-select {
      border-radius: 8px;
      padding: 0.75rem 1rem;
      border: 1px solid #e0e0e0;
      transition: var(--transition);
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.15);
    }

    .btn-primary {
      background-color: var(--primary-color);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: var(--transition);
    }

    .btn-primary:hover {
      background-color: #2e59d9;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(78, 115, 223, 0.25);
    }

    .btn-outline-secondary {
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      transition: var(--transition);
    }

    .btn-outline-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 2rem 0;
      color: #6c757d;
      font-size: 0.9rem;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #e0e0e0;
    }

    .divider:not(:empty)::before {
      margin-right: 1.25rem;
    }

    .divider:not(:empty)::after {
      margin-left: 1.25rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .settings-card .card-body {
        padding: 1.25rem;
      }

      .profile-info p {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }

      .profile-info strong {
        margin-bottom: 0.25rem;
      }
    }

    /* Add other relevant dashboard styles here if needed for content */
  </style>

</head>

<body class="starter-page-page">

  <button class="btn btn-primary d-md-none position-fixed" id="sidebarToggle"
    style="z-index: 9999; top: 1rem; left: 1rem;">
    <i class="bi bi-list"></i>
  </button>

  <main class="main">
    <nav id="sidebar" class="d-md-block sidebar">
      <div class="position-sticky pt-3">
        <div class="text-center mb-4">
          <div id="userInitials" class="initials-circle"></div>
          <h6 id="userName" class="text-white mb-0"></h6>
          <small id="userRole" class="text-white-50">User</small>
        </div>
        <hr class="mx-3 my-4 bg-white-50">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-house-door me-2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="analytics.html">
              <i class="bi bi-graph-up me-2"></i>
              Analytics
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reports.html">
              <i class="bi bi-bar-chart me-2"></i>
              Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="settings.html">
              <i class="bi bi-gear me-2"></i>
              Settings
            </a>
          </li>
        </ul>
        <hr class="mx-3 my-4 bg-white-50">
        <div class="px-3 pb-3">
          <a class="nav-link text-white" href="#" onclick="api.auth.logout()">
            <i class="bi bi-box-arrow-right me-2"></i>
            Logout
          </a>
        </div>
      </div>
    </nav>

    <div class="main-content">
      <div class="container-fluid p-0">
        <div
          class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom px-3">
          <div class="d-flex align-items-center">
            <div class="icon-circle bg-primary-light me-3 d-flex align-items-center justify-content-center"
              style="width: 48px; height: 48px; border-radius: 12px;">
              <i class="bi bi-gear-fill" style="font-size: 1.5rem; color: var(--primary-color);"></i>
            </div>
            <div>
              <h1 class="h3 mb-1">Account Settings</h1>
              <p class="text-muted mb-0">Manage your profile and account preferences</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-0">
        <div class="col-lg-6">
          <div class="settings-card">
            <div class="card-header d-flex align-items-center">
              <i class="bi bi-person-circle me-2"></i>
              <h6 class="mb-0">Profile Information</h6>
            </div>
            <div class="card-body">
              <div class="profile-info">
                <p>
                  <strong><i class="bi bi-person"></i> Full Name</strong>
                  <span id="profileFullName" class="ms-2">Loading...</span>
                </p>
                <p>
                  <strong><i class="bi bi-envelope"></i> Email</strong>
                  <span id="profileEmail" class="ms-2">Loading...</span>
                </p>
                <p>
                  <strong><i class="bi bi-calendar"></i> Member Since</strong>
                  <span id="profileCreatedAt" class="ms-2">Loading...</span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="settings-card">
            <div class="card-header d-flex align-items-center">
              <i class="bi bi-pencil-square me-2"></i>
              <h6 class="mb-0">Update Profile</h6>
            </div>
            <div class="card-body">
              <form id="updateProfileForm">
                <div class="mb-4">
                  <label for="updateFullName" class="form-label">
                    <i class="bi bi-person-fill"></i> Full Name
                  </label>
                  <input type="text" class="form-control" id="updateFullName" required
                    placeholder="Enter your full name">
                </div>
                <div class="mb-4">
                  <label for="updateEmail" class="form-label">
                    <i class="bi bi-envelope-fill"></i> Email Address
                  </label>
                  <input type="email" class="form-control" id="updateEmail" required
                    placeholder="Enter your email address">
                </div>
                <div class="d-flex justify-content-end gap-2">
                  <button type="reset" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                  </button>
                  <button type="submit" class="btn btn-primary" id="updateProfileBtn">
                    <i class="bi bi-save me-1"></i> Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="settings-card">
            <div class="card-header">
              <i class="bi bi-shield-lock"></i>
              <h6>Change Password</h6>
            </div>
            <div class="card-body">
              <form id="changePasswordForm">
                <div class="row g-4">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="currentPassword" class="form-label">
                        <i class="bi bi-key-fill"></i> Current Password
                      </label>
                      <input type="password" class="form-control" id="currentPassword" required
                        placeholder="Enter current password">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="newPassword" class="form-label">
                        <i class="bi bi-key"></i> New Password
                      </label>
                      <input type="password" class="form-control" id="newPassword" required
                        placeholder="Enter new password" minlength="8">
                      <small class="form-text text-muted">Minimum 8 characters</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="confirmPassword" class="form-label">
                        <i class="bi bi-key-fill"></i> Confirm New Password
                      </label>
                      <input type="password" class="form-control" id="confirmPassword" required
                        placeholder="Confirm new password">
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-4">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-key me-1"></i> Update Password
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="settings-card border-danger">
            <div class="card-header bg-danger bg-opacity-10 text-danger d-flex align-items-center">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <h6 class="mb-0">Danger Zone</h6>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h6 class="text-danger mb-1">Delete Account</h6>
                  <p class="mb-0 text-muted">Permanently delete your account and all associated data. This action cannot
                    be undone.</p>
                </div>
                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                  <i class="bi bi-trash me-1"></i> Delete Account
                </button>
              </div>
              <div class="alert alert-warning d-flex align-items-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div>
                  <strong>Warning:</strong> This will permanently delete all your data including subscriptions and
                  preferences.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header border-0">
                <h5 class="modal-title text-danger" id="deleteAccountModalLabel">Delete Your Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                  <i class="bi bi-exclamation-octagon-fill me-2"></i>
                  <div>This action cannot be undone. All your data will be permanently deleted.</div>
                </div>
                <p>To confirm, please type <strong>delete my account</strong> below:</p>
                <input type="text" id="confirmDeleteInput" class="form-control mb-3"
                  placeholder="Type 'delete my account' to confirm">
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="confirmCheckbox">
                  <label class="form-check-label" for="confirmCheckbox">
                    I understand that this action is irreversible
                  </label>
                </div>
              </div>
              <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>Delete My Account</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
    </div>
    </div>
    </div>

  </main>
  </div>
  </div>
  </main>

  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <div id="preloader"></div>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="assets/js/main.js"></script>
  <script src="assets/js/api.js"></script>

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toastContainer" class="toast-container">
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Check login status
      if (!api.auth.isLoggedIn()) {
        window.location.href = '/login.html';
        return;
      }

      // Show Bootstrap toast notification
      function showToast(type, message) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.role = 'alert';
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.id = toastId;

        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;

        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 5000 });
        bsToast.show();

        // Remove toast from DOM after it's hidden
        toast.addEventListener('hidden.bs.toast', function () {
          toast.remove();
        });
      }

      // Account Deletion Modal Logic
      const deleteModal = document.getElementById('deleteAccountModal');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      const confirmDeleteInput = document.getElementById('confirmDeleteInput');
      const confirmCheckbox = document.getElementById('confirmCheckbox');

      // Enable/disable delete button based on confirmation
      function updateDeleteButtonState() {
        const isConfirmed = confirmDeleteInput.value.toLowerCase() === 'delete my account';
        confirmDeleteBtn.disabled = !(isConfirmed && confirmCheckbox.checked);
      }

      confirmDeleteInput.addEventListener('input', updateDeleteButtonState);
      confirmCheckbox.addEventListener('change', updateDeleteButtonState);

      // Handle account deletion
      confirmDeleteBtn.addEventListener('click', async function () {
        if (!confirmDeleteBtn.disabled) {
          // Show SweetAlert confirmation
          const result = await Swal.fire({
            title: 'Are you absolutely sure?',
            text: 'This action cannot be undone. This will permanently delete your account and all associated data.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete my account',
            cancelButtonText: 'Cancel',
            reverseButtons: true,
            customClass: {
              confirmButton: 'btn btn-danger',
              cancelButton: 'btn btn-secondary me-2'
            },
            buttonsStyling: false
          });

          if (result.isConfirmed) {
            try {
              // Show loading state in SweetAlert
              Swal.fire({
                title: 'Deleting your account...',
                text: 'Please wait while we remove your data.',
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                }
              });

              // Call the API to delete the account
              const response = await api.user.deleteAccount();

              if (response.success) {
                // Show success message
                await Swal.fire({
                  icon: 'success',
                  title: 'Account Deleted',
                  text: 'Your account has been successfully deleted.',
                  confirmButtonText: 'Go to Login',
                  allowOutsideClick: false,
                  willClose: () => {
                    // Force a hard redirect to ensure user is logged out
                    window.location.href = response.redirect || '/login.html?accountDeleted=true';
                  }
                });

                // Force redirect after a short delay in case the user doesn't click the button
                setTimeout(() => {
                  window.location.href = response.redirect || '/login.html?accountDeleted=true';
                }, 2000);
              } else {
                throw new Error(response.message || 'Failed to delete account');
              }
            } catch (error) {
              console.error('Error deleting account:', error);

              // Hide loading state
              Swal.close();

              // Show error message
              await Swal.fire({
                icon: 'error',
                title: 'Deletion Failed',
                text: error.message || 'An error occurred while deleting your account. Please try again.',
                confirmButtonText: 'OK'
              });

              // Reset button state
              confirmDeleteBtn.disabled = false;
              confirmDeleteBtn.textContent = 'Delete My Account';
            }
          } else {
            // User cancelled the deletion
          }
        }
      });

      // Reset modal state when hidden
      const modalInstance = new bootstrap.Modal(deleteModal);
      deleteModal.addEventListener('hidden.bs.modal', function () {
        confirmDeleteInput.value = '';
        confirmCheckbox.checked = false;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = 'Delete My Account';
      });

      // Show toast if redirected after account deletion
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('deleted')) {
        showToast('success', 'Your account has been successfully deleted.');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // Load user info if logged in (from localStorage initially)
      const user = api.auth.getCurrentUser();
      if (!user) {
        window.location.href = '/login.html';
        return;
      }

      // Update sidebar user profile (from localStorage initially)
      const initials = user.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
      document.getElementById('userInitials').innerText = initials;
      document.getElementById('userName').innerText = user.full_name;

      // Populate profile information with initial data (from localStorage)
      document.getElementById('profileFullName').innerText = user.full_name || 'N/A';
      document.getElementById('profileEmail').innerText = user.email || 'N/A';
      document.getElementById('profileCreatedAt').innerText = 'Loading...'; // Placeholder

      // Fetch full user details from backend to get created_at and potentially update other info
      async function fetchUserProfile() {
        try {
          // Use the existing API function to fetch authenticated user profile
          const response = await api.user.getUserDetails();

          // Check if the response has status 'success' and contains data
          if (response && response.status === 'success' && response.data) {
            const fullUser = response.data;

            // Populate profile information from backend data
            document.getElementById('profileFullName').innerText = fullUser.full_name || 'N/A';
            document.getElementById('profileEmail').innerText = fullUser.email || 'N/A';

            // Format and display the created_at date if available
            if (fullUser.created_at) {
              // Handle potential different date formats (ISO string or Date object)
              const dateValue = typeof fullUser.created_at === 'string'
                ? new Date(fullUser.created_at)
                : (fullUser.created_at instanceof Date ? fullUser.created_at : null);

              if (dateValue && !isNaN(dateValue)) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('profileCreatedAt').innerText = dateValue.toLocaleDateString(undefined, options);
              } else {
                console.error('Invalid created_at date format:', fullUser.created_at);
                document.getElementById('profileCreatedAt').innerText = 'Invalid date format';
              }
            } else {
              document.getElementById('profileCreatedAt').innerText = 'Date not available';
            }

            // Optionally update localStorage with full user data if needed for other pages
            // localStorage.setItem('user', JSON.stringify(fullUser));

          } else {
            console.error('Failed to fetch full user profile: Invalid response format or status', response);
            // Keep initial data or set to error
            document.getElementById('profileCreatedAt').innerText = response?.message || 'Error loading date';
          }
        } catch (error) {
          console.error('Error fetching user profile:', error);
          document.getElementById('profileCreatedAt').innerText = 'Error loading date';
        }
      }

      // Load current user data into the form
      function loadCurrentUserData() {
        const currentUser = api.auth.getCurrentUser();
        if (currentUser) {
          const fullNameInput = document.getElementById('updateFullName');
          const emailInput = document.getElementById('updateEmail');

          if (fullNameInput) fullNameInput.value = currentUser.full_name || '';
          if (emailInput) emailInput.value = currentUser.email || '';

          console.log('Loaded user data:', {
            fullName: currentUser.full_name,
            email: currentUser.email
          });
        } else {
          console.error('No current user found');
        }
      }

      // Initialize user profile and load data into forms
      console.log('DOM fully loaded, initializing profile and forms...');
      fetchUserProfile();
      loadCurrentUserData();

      // Set up form submission handler for profile update
      const updateProfileForm = document.getElementById('updateProfileForm');
      if (updateProfileForm) {
        console.log('Found update profile form, adding submit handler...');

        const submitButton = document.getElementById('updateProfileBtn');

        async function handleProfileUpdate(event) {
          console.log('Form/button event triggered for profile update');
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }

          const updateFullNameInput = document.getElementById('updateFullName');
          const updateEmailInput = document.getElementById('updateEmail');

          if (!updateFullNameInput || !updateEmailInput || !submitButton) {
            console.error('Could not find all required form elements for profile update');
            return;
          }

          const full_name = updateFullNameInput.value.trim();
          const email = updateEmailInput.value.trim();

          console.log('Profile update form values:', { full_name, email });

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            await Swal.fire({
              icon: 'error',
              title: 'Invalid Email',
              text: 'Please enter a valid email address',
              confirmButtonColor: '#3085d6',
            });
            return;
          }

          if (!full_name || !email) {
            await Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Please fill in all required fields',
              confirmButtonColor: '#3085d6',
            });
            return;
          }

          const originalButtonText = submitButton.innerHTML;
          submitButton.disabled = true;
          submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Updating...';

          try {
            const response = await fetch('/api/user/profile', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              },
              body: JSON.stringify({
                full_name: full_name,
                email: email
              })
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Failed to update profile');
            }

            await Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Your profile has been updated successfully.',
              confirmButtonColor: '#3085d6',
              confirmButtonText: 'OK'
            });

            const profileFullName = document.getElementById('profileFullName');
            const profileEmail = document.getElementById('profileEmail');

            if (profileFullName) profileFullName.textContent = full_name;
            if (profileEmail) profileEmail.textContent = email;

            const userData = JSON.parse(localStorage.getItem('user') || '{}');
            userData.full_name = full_name;
            userData.email = email;
            localStorage.setItem('user', JSON.stringify(userData));

            if (window.auth && typeof window.auth.setUser === 'function') {
              window.auth.setUser(userData);
            }

            const initialsElement = document.getElementById('userInitials');
            const userNameElement = document.getElementById('userName');
            if (initialsElement) {
              const initials = full_name.split(' ').map(n => n[0]).join('').toUpperCase();
              initialsElement.textContent = initials;
            }
            if (userNameElement) {
              userNameElement.textContent = full_name;
            }

          } catch (error) {
            console.error('Error updating profile:', error);
            let errorMessage = 'Failed to update profile. Please try again.';
            let errorTitle = 'Update Failed';
            let showReload = false;

            if (error.message) {
              if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Unable to connect to the server. Please check your internet connection and try again.';
                showReload = true;
              } else if (error.message.includes('email already in use')) {
                errorMessage = 'This email address is already in use. Please use a different email.';
              } else if (error.message.includes('invalid token') || error.message.includes('jwt expired')) {
                errorMessage = 'Your session has expired. Please log in again.';
                showReload = true;
                setTimeout(() => {
                  window.location.href = '/login.html';
                }, 2000);
              } else {
                errorMessage = error.message;
              }
            }

            const result = await Swal.fire({
              icon: 'error',
              title: errorTitle,
              text: errorMessage,
              confirmButtonColor: '#3085d6',
              confirmButtonText: showReload ? 'Reload Page' : 'OK',
              showCancelButton: showReload,
              cancelButtonText: 'Cancel',
              allowOutsideClick: !showReload
            });

            if (showReload && result.isConfirmed) {
              window.location.reload();
            }
          } finally {
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.innerHTML = originalButtonText;
            }
          }
        }

        if (submitButton) {
          submitButton.addEventListener('click', handleProfileUpdate);
        }
        updateProfileForm.addEventListener('submit', handleProfileUpdate);
      } else {
        console.error('Update profile form not found.');
      }
    }); // End of DOMContentLoaded
  </script>

  <script>
    // Password Change Handler
    function setupPasswordChange() {
      const form = document.getElementById('changePasswordForm');
      if (!form) {
        console.error('Change password form not found.');
        return;
      }

      form.addEventListener('submit', handlePasswordSubmit);
    }

    async function handlePasswordSubmit(event) {
      event.preventDefault();
      console.log('Form/button event triggered for password change');

      const form = event.target;
      const currentPasswordInput = form.currentPassword;
      const newPasswordInput = form.newPassword;
      const confirmNewPasswordInput = form.confirmPassword;

      const currentPassword = currentPasswordInput?.value;
      const newPassword = newPasswordInput?.value;
      const confirmPassword = confirmNewPasswordInput?.value;
      const submitButton = form.querySelector('button[type="submit"]');

      if (!currentPasswordInput || !newPasswordInput || !confirmNewPasswordInput || !submitButton) {
        console.error('Could not find all required form elements for password change');
        return;
      }

      if (newPassword !== confirmPassword) {
        showError('New password and confirm password do not match.');
        return;
      }

      if (newPassword.length < 8) {
        showError('Password must be at least 8 characters long.');
        return;
      }

      const originalButtonHTML = submitButton.innerHTML;
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Updating...';
      }

      try {
        const response = await fetch(`${window.API_BASE_URL || ''}/user/password`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            ...(window.getAuthHeader ? window.getAuthHeader() : {}) // Ensure getAuthHeader is available
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
          })
        });

        const data = await response.json();
        console.log('Change password response:', data);

        if (!response.ok) {
          let errorMessage = data.error || data.message || 'Failed to change password';
          if (response.status === 401) { // Unauthorized often means wrong current password
            errorMessage = 'Invalid current password. Please try again.';
          }
          throw new Error(errorMessage);
        }

        form.reset(); // Clear form on success
        showSuccess(data.message || 'Password changed successfully!');

      } catch (error) {
        console.error('Password change error:', error);
        showError(error.message || 'Failed to change password. Please try again.');
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonHTML; // Restore original button HTML
        }
      }
    }

    function showError(message) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: message,
        confirmButtonColor: '#3085d6'
      });
    }

    function showSuccess(message) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: message,
        confirmButtonColor: '#3085d6'
      });
    }

    // Initialize when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupPasswordChange);
    } else {
      setupPasswordChange(); // Call it directly if DOM is already loaded
    }
  </script>

</body>

</html>