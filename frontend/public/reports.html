<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Reports - ML Project</title>
  <meta name="description" content="User reports dashboard for the ML Project.">
  <meta name="keywords" content="ML, Machine Learning, Prediction, Locust, Reports, Dashboard">

  <!-- Favicons -->
  <link href="assets/img/logo.webp" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;0,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* Custom styles from dashboard.html sidebar */
    :root {
      --primary-color: #4e73df;
      --secondary-color: #1cc88a;
      --warning-color: #f6c23e;
      --info-color: #36b9cc;
      --dark-color: #5a5c69;
      --light-bg: #f8f9fc;
    }

    body {
      background-color: var(--light-bg);
    }

    .sidebar {
      background: linear-gradient(180deg, var(--primary-color) 0%, #224abe 100%);
      min-height: 100vh;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    .sidebar .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 1rem;
      margin: 0.2rem 0;
      border-radius: 0.35rem;
      transition: all 0.3s;
    }

    .sidebar .nav-link:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .sidebar .nav-link.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
    }

    .sidebar .nav-link i {
      margin-right: 0.5rem;
    }

    .sidebar .nav-link.text-danger {
      color: #fff !important;
    }

    .sidebar .text-center h6, .sidebar .text-center small {
      color: white !important;
    }

    .initials-circle {
      width: 80px;
      height: 80px;
      background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white */
      color: white;
      font-size: 2rem;
      font-weight: bold;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.5rem auto;
    }

    /* Additional styles for enhanced reports */
    .stat-card {
      border-radius: 10px;
      border: none;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card .card-body {
      padding: 1.5rem;
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
    }

    /* Enhanced Filter Styles */
    .filter-section {
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 0.15rem 1.5rem 0 rgba(58, 59, 69, 0.08);
      transition: all 0.2s ease;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .filter-section:hover {
      box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.12);
    }
    
    .filter-section .card-header {
      background: #f8f9fc;
      border-bottom: 1px solid #e3e6f0;
      padding: 0.75rem 1.25rem;
    }
    
    .form-control-sm, .form-select-sm {
      font-size: 0.825rem;
      padding: 0.35rem 0.75rem;
      height: calc(1.5em + 0.5rem + 2px);
      border-radius: 0.25rem;
      transition: all 0.15s ease;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #4e73df;
      box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.15);
    }
    
    .form-label {
      font-weight: 500;
      color: #5a5c69;
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
    }
    
    .input-group-text {
      background-color: #f8f9fc;
      border: 1px solid #d1d3e2;
      font-size: 0.8rem;
      color: #6e707e;
    }
    
    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.8rem;
      border-radius: 0.25rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
    }
    
    .badge {
      font-weight: 500;
      padding: 0.25em 0.6em;
      font-size: 0.7em;
    }
    
    .bg-primary-soft {
      background-color: rgba(78, 115, 223, 0.1) !important;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 2rem;
    }

    .export-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .date-range-picker {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .bulk-actions {
      display: none;
      background: #e3e6f0;
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 1rem;
    }

    .bulk-actions.show {
      display: block;
    }

    .table-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
  </style>

  <!-- =======================================================
  * Template Name: Invent
  * Template URL: https://bootstrapmade.com/invent-bootstrap-business-template/
  * Updated: May 12 2025 with Bootstrap v5.3.6
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body class="starter-page-page">

  <main class="main">
    <div class="container-fluid">
      <div class="row">        
        <!-- Sidebar -->
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse pt-3">
          <div class="position-sticky">
            <div class="text-center mb-4">
              <div id="userInitials" class="initials-circle"></div>
              <h6 id="userName" class="mb-0"></h6>
            </div>
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link" href="dashboard.html">
                  <i class="bi bi-house-door me-2"></i>
                  Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="analytics.html">
                  <i class="bi bi-graph-up me-2"></i>
                  Analytics
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="predict.html">
                  <i class="bi bi-lightning-charge-fill me-2"></i>
                  Prediction
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="reports.html">
                  <i class="bi bi-bar-chart me-2"></i>
                  Reports
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="settings.html">
                  <i class="bi bi-gear me-2"></i>
                  Settings
                </a>
              </li>
              <li class="nav-item mt-4">
                <a class="nav-link text-danger" href="#" onclick="api.auth.logout()">
                  <i class="bi bi-box-arrow-right me-2"></i>
                  Logout
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 pt-5">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h2>Reports & Analytics</h2>
              <p class="text-muted mb-0">Comprehensive analysis of your prediction history</p>
            </div>
            <div class="export-buttons">
              <button class="btn btn-sm btn-outline-primary" onclick="exportToCSV()">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="exportToPDF()">
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                <i class="bi bi-printer"></i> Print
              </button>
            </div>
          </div>

          <!-- Summary Statistics -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card stat-card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="stat-icon bg-primary bg-gradient">
                      <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="ms-3">
                      <h6 class="text-muted mb-1">Total Predictions</h6>
                      <h3 class="mb-0" id="totalPredictions">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card stat-card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="stat-icon bg-danger bg-gradient">
                      <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="ms-3">
                      <h6 class="text-muted mb-1">Locust Detected</h6>
                      <h3 class="mb-0" id="locustDetected">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card stat-card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="stat-icon bg-success bg-gradient">
                      <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="ms-3">
                      <h6 class="text-muted mb-1">No Locust</h6>
                      <h3 class="mb-0" id="noLocust">0</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card stat-card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="stat-icon bg-info bg-gradient">
                      <i class="bi bi-percent"></i>
                    </div>
                    <div class="ms-3">
                      <h6 class="text-muted mb-1">Detection Rate</h6>
                      <h3 class="mb-0" id="detectionRate">0%</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">Predictions Over Time</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">Regional Distribution</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="regionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Advanced Filters -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
              <h6 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-funnel me-2 text-primary"></i>
                <span>Advanced Filters</span>
                <span class="badge bg-primary-soft text-primary ms-2" id="activeFilterCount">0 active</span>
              </h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <!-- Date Range -->
                <div class="col-md-6 col-lg-3">
                  <label class="form-label small text-muted mb-1">Date Range</label>
                  <div class="input-group input-group-sm">
                    <input type="date" id="startDate" class="form-control form-control-sm border-end-0" placeholder="Start Date">
                    <span class="input-group-text bg-light border-0 px-2">to</span>
                    <input type="date" id="endDate" class="form-control form-control-sm border-start-0" placeholder="End Date">
                  </div>
                </div>

                <!-- Region Filter -->
                <div class="col-md-6 col-lg-2">
                  <label class="form-label small text-muted mb-1">Region</label>
                  <div class="input-group input-group-sm">
                    <select id="regionFilter" class="form-select form-select-sm">
                      <option value="">All Regions</option>
                    </select>
                  </div>
                </div>

                <!-- Country Filter -->
                <div class="col-md-6 col-lg-2">
                  <label class="form-label small text-muted mb-1">Country</label>
                  <div class="input-group input-group-sm">
                    <select id="countryFilter" class="form-select form-select-sm">
                      <option value="">All Countries</option>
                    </select>
                  </div>
                </div>

                <!-- Status Filter -->
                <div class="col-md-6 col-lg-2">
                  <label class="form-label small text-muted mb-1">Status</label>
                  <div class="input-group input-group-sm">
                    <select id="statusFilter" class="form-select form-select-sm">
                      <option value="">All Status</option>
                      <option value="1">Locust Present</option>
                      <option value="0">No Locust</option>
                    </select>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="col-12 col-lg-3 d-flex align-items-end">
                  <button class="btn btn-primary btn-sm me-2 px-3" onclick="applyFilters()">
                    <i class="bi bi-funnel me-1"></i> Apply
                  </button>
                  <button class="btn btn-outline-secondary btn-sm px-3" onclick="clearFilters()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Bulk Actions -->
          <div class="bulk-actions" id="bulkActions">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span id="selectedCount">0</span> items selected
              </div>
              <div>
                <button class="btn btn-sm btn-danger" onclick="bulkDelete()">
                  <i class="bi bi-trash"></i> Delete Selected
                </button>
                <button class="btn btn-sm btn-primary" onclick="exportSelected()">
                  <i class="bi bi-download"></i> Export Selected
                </button>
              </div>
            </div>
          </div>
          
          <!-- Reports Content -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">User Prediction Report</h5>
                  <!-- Placeholder for report content -->
                  <div id="reportContent">
                     <div class="row">
                        <div class="col-md-12 mb-4">
                           <div class="card">
                              <div class="card-body">
                                 <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">Prediction History</h5>
                                    <div class="d-flex gap-2">
                                       <button class="btn btn-sm btn-outline-primary" onclick="toggleBulkSelect()">
                                          <i class="bi bi-check-square"></i> Select Multiple
                                       </button>
                                    </div>
                                 </div>
                                 <div class="table-responsive">
                                    <table class="table table-hover">
                                       <thead>
                                          <tr>
                                             <th class="bulk-select-header" style="display: none;">
                                                <input type="checkbox" class="table-checkbox" id="selectAll" onchange="toggleSelectAll()">
                                             </th>
                                             <th>Date</th>
                                             <th>Region</th>
                                             <th>Country</th>
                                             <th>Status</th>
                                             <th>Actions</th>
                                          </tr>
                                       </thead>
                                       <tbody id="predictionHistory">
                                          <!-- Predictions will be loaded here -->
                                       </tbody>
                                    </table>
                                    <!-- Pagination -->
                                    <nav aria-label="Page navigation" class="mt-3">
                                       <ul class="pagination pagination-sm justify-content-center" id="pagination">
                                          <!-- Pagination will be added here by JavaScript -->
                                       </ul>
                                    </nav>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Add more reports content here as needed -->

        </main>
      </div>
    </div>
  </main>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  
  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>
  <script src="assets/js/api.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check login status
      if (!api.auth.isLoggedIn()) {
        window.location.href = '/login.html';
        return;
      }
      
      // Load user info if logged in
      const user = api.auth.getCurrentUser();
      if (!user) {
         window.location.href = '/login.html';
         return;
      }

      // Update user profile
      const initials = user.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
      document.getElementById('userInitials').innerText = initials;
      document.getElementById('userName').innerText = user.full_name;
      // You can add user email if you want:
      // document.querySelector('.profile-card p').innerText = user.email;

      // You can add JavaScript here to fetch and display report data later
      console.log("Reports page loaded for user:", user.email);
      
      // Example of where you might fetch data:
      // async function loadReports() {
      //   try {
      //     const predictions = await api.predictions.getAll();
      //     console.log("Fetched predictions for report:", predictions);
      //     // Render predictions in a table in the #reportContent div
      //   } catch (error) {
      //     console.error("Error loading report data:", error);
      //     document.getElementById('reportContent').innerHTML = '<p class="text-danger">Error loading report data.</p>';
      //   }
      // }
      // loadReports();
    });

    // Function to load user's predictions
    async function loadUserPredictions() {
      const tbody = document.getElementById('predictionHistory');
      if (!tbody) {
        console.error('Table body element not found');
        return;
      }

      try {
        console.log('Loading user predictions...');
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <div>Loading predictions...</div>
            </td>
          </tr>`;

        const response = await api.predictions.getAll();
        console.log('API Response:', response);

        // Handle the response format
        let predictions = [];
        if (response && response.status === 'success' && Array.isArray(response.data)) {
            predictions = response.data;
        } else if (response && response.error) {
            throw new Error(response.details || response.error);
        } else if (Array.isArray(response)) {
            // Fallback for old format
            predictions = response;
        }

        console.log('Processed predictions:', predictions);

        // Clear existing rows
        tbody.innerHTML = '';

        if (!predictions || predictions.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td colspan="5" class="text-center py-4">
              <div class="text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No prediction history found. Make your first prediction to see it here!
              </div>
              <button class="btn btn-sm btn-outline-primary mt-2" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </td>
          `;
          tbody.appendChild(tr);
          return;
        }

        // Store all predictions for filtering/pagination
        allPredictions = predictions;
        currentPage = 1; // Reset to first page
        
        // Update statistics
        updateStatistics(predictions);
        
        // Update charts
        updateCharts(predictions);
        
        // Populate filter dropdowns
        populateFilterDropdowns(predictions);
        
        // Apply initial filters
        applyFilters();

        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-prediction').forEach(button => {
          button.addEventListener('click', handleDeletePrediction);
        });

      } catch (error) {
        console.error('Error loading predictions:', error);
        const errorMessage = error.message || 'Unknown error occurred';
        const statusCode = error.status || 'N/A';

        // Log detailed error information
        console.error('Error details:', {
          message: errorMessage,
          status: statusCode,
          timestamp: new Date().toISOString()
        });

        // Update the UI with error message
        const tbody = document.getElementById('predictionHistory');
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center py-4">
                <div class="alert alert-danger">
                  <h6 class="alert-heading">Error Loading Predictions</h6>
                  <p class="mb-1">${errorMessage}</p>
                  <p class="mb-0 small">Status: ${statusCode}</p>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadUserPredictions()">
                  <i class="bi bi-arrow-clockwise"></i> Retry
                </button>
              </td>
            </tr>
          `;
        }

        // Show error toast with more details
        Swal.fire({
          icon: 'error',
          title: 'Error Loading Data',
          html: `
            <div class="text-start">
              <p class="mb-2">Failed to load prediction history:</p>
              <code class="d-block bg-light p-2 mb-2">${errorMessage}</code>
              <p class="text-muted small mb-0">Status: ${statusCode}</p>
            </div>
          `,
          confirmButtonText: 'OK',
          confirmButtonColor: '#3085d6',
          allowOutsideClick: false
        });
      }
    }

    // Function to handle prediction deletion
    async function handleDeletePrediction(event) {
      event.stopPropagation(); // Prevent any parent click events
      const button = event.currentTarget;
      const row = button.closest('tr');
      const predictionId = button.dataset.id;

      if (!predictionId) {
        console.error('No prediction ID found');
        return;
      }

      // Save original button state
      const originalButtonHTML = button.innerHTML;
      const originalButtonWidth = button.offsetWidth;
      button.style.width = `${originalButtonWidth}px`;

      try {
        const result = await Swal.fire({
          title: 'Are you sure?',
          text: 'This will permanently delete this prediction.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete it!',
          cancelButtonText: 'Cancel',
          reverseButtons: true,
          allowOutsideClick: false
        });

        if (result.isDismissed) {
          return; // User cancelled the deletion
        }

        // Show loading state
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Deleting...';

        // Disable other action buttons in the same row
        const actionButtons = row.querySelectorAll('button');
        actionButtons.forEach(btn => {
          if (btn !== button) btn.disabled = true;
        });

        try {
          // Call the API to delete the prediction
          const response = await api.predictions.delete(predictionId);
          console.log('Delete response:', response);

          // Show success message
          const toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
          });

          await toast.fire({
            icon: 'success',
            title: 'Prediction deleted successfully'
          });

          // Refresh the predictions list which will also update the stats
          await loadUserPredictions();

        } catch (error) {
          console.error('Error deleting prediction:', error);

          // Show error message
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Failed to delete prediction. Please try again.',
            confirmButtonColor: '#3085d6'
          });

          // Reset button state
          button.disabled = false;
          button.innerHTML = originalButtonHTML;

          // Re-enable other buttons
          const actionButtons = row.querySelectorAll('button');
          actionButtons.forEach(btn => {
            btn.disabled = false;
          });

          return; // Stop further execution
        }

      } catch (error) {
        console.error('Error deleting prediction:', error);

        // Reset button state
        button.disabled = false;
        button.innerHTML = originalButtonHTML;

        // Show error message
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message || 'Failed to delete prediction. Please try again.',
          confirmButtonColor: '#3085d6'
        });
      }
    }

    // Handle view prediction
    async function handleViewPrediction(event) {
      const button = event.currentTarget;
      const predictionId = button.getAttribute('data-id');

      // Store original button content at the start
      const originalContent = button.innerHTML;

      try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Loading...';

        // Disable other action buttons in the same row during loading
        const row = button.closest('tr');
        if (row) {
          const actionButtons = row.querySelectorAll('button');
          actionButtons.forEach(btn => {
            if (btn !== button) btn.disabled = true;
          });
        }

        // Fetch the prediction details
        const response = await fetch(`${API_BASE_URL}/predictions/${predictionId}`, {
          headers: getAuthHeader()
        });

        const data = await response.json();

        if (!response.ok || data.status !== 'success') {
          console.error('API Error:', data);
          throw new Error(data.message || 'Failed to fetch prediction details');
        }

        const prediction = data.data;
        
        // Debug: Log the complete prediction object and its structure
        console.log('Complete prediction object:', prediction);
        console.log('All prediction properties:');
        Object.entries(prediction).forEach(([key, value]) => {
          console.log(`${key}:`, value, `(type: ${typeof value})`);
        });
        
        // Check if we have a status field that might contain the locust presence info
        const hasStatusField = 'status' in prediction;
        console.log('Has status field?', hasStatusField);
        if (hasStatusField) {
          console.log('Status value:', prediction.status, 'type:', typeof prediction.status);
        }

        // Format the data for display
        const formattedData = [
          { label: 'User', value: prediction.full_name || 'N/A', icon: 'person' },
          { label: 'Email', value: prediction.email || 'N/A', icon: 'envelope' },
          { label: 'Start Year', value: prediction.start_year || 'N/A', icon: 'calendar' },
          { label: 'Start Month', value: getMonthName(prediction.start_month) || 'N/A', icon: 'calendar-month' },
          { label: 'PPT', value: prediction.ppt ? `${prediction.ppt} mm` : 'N/A', icon: 'cloud-rain' },
          { label: 'TMAX', value: prediction.tmax ? `${prediction.tmax}°C` : 'N/A', icon: 'thermometer-high' },
          { label: 'Soil Moisture', value: prediction.soil_moisture || 'N/A', icon: 'moisture' }
        ];

        // Create HTML for the cards
        const cardsHtml = formattedData.map(item => `
          <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-body text-center">
                <div class="mb-2">
                  <i class="bi bi-${item.icon} fs-2 text-primary"></i>
                </div>
                <h5 class="card-title mb-1">${item.label}</h5>
                <p class="card-text fs-5 fw-bold">${item.value}</p>
              </div>
            </div>
          </div>
        `).join('');

        // Show the SweetAlert with the prediction details
        Swal.fire({
          title: 'Prediction Details',
          html: `
            <div class="container-fluid">
              <div class="row g-3">
                ${cardsHtml}
              </div>
            </div>
          `,
          width: '80%',
          showCloseButton: true,
          showConfirmButton: false,
          customClass: {
            container: 'sweet-container',
            popup: 'sweet-popup',
            title: 'sweet-title',
            htmlContainer: 'sweet-html'
          }
        });

      } catch (error) {
        console.error('Error viewing prediction:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load prediction details. Please try again.',
          confirmButtonColor: '#3085d6',
        });
      } finally {
        // Reset button state
        button.disabled = false;
        button.innerHTML = originalContent;
      }
    }

    // Helper function to get month name from number (1-12)
    function getMonthName(monthNumber) {
      if (!monthNumber) return 'N/A';
      const date = new Date(2000, monthNumber - 1, 1);
      return date.toLocaleString('default', { month: 'long' });
    }

    // Pagination and search state
    let currentPage = 1;
    const rowsPerPage = 5; // Show 5 rows per page
    let allPredictions = [];
    let filteredPredictions = [];
    let selectedPredictions = new Set();
    let bulkSelectMode = false;
    let timelineChart = null;
    let regionChart = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      loadUserPredictions();
      initializeCharts();
    });

    // Filter predictions by date and paginate
    function filterAndDisplayPredictions(searchDate) {
      let filteredPredictions = [...allPredictions];

      // Filter by date if search date is provided
      if (searchDate) {
        const searchDateObj = new Date(searchDate);
        const searchDateStr = searchDateObj.toISOString().split('T')[0];

        filteredPredictions = filteredPredictions.filter(prediction => {
          const predDate = new Date(prediction.created_at).toISOString().split('T')[0];
          return predDate === searchDateStr;
        });
      }

      // Update pagination
      updatePagination(filteredPredictions);

      // Display current page
      displayPredictionsPage(filteredPredictions, currentPage);
    }

    // Update pagination controls
    function updatePagination(predictions) {
      const totalPages = Math.ceil(predictions.length / rowsPerPage);
      const paginationEl = document.getElementById('pagination');

      if (!paginationEl) return;

      let paginationHTML = '';

      // Previous button
      paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>`;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>`;
      }

      // Next button
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>`;

      paginationEl.innerHTML = paginationHTML;

      // Add click handlers for pagination
      document.querySelectorAll('.page-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const page = parseInt(e.target.getAttribute('data-page') || e.target.parentElement.getAttribute('data-page'));
          if (page && page !== currentPage && page > 0 && page <= totalPages) {
            currentPage = page;
            const searchDate = document.getElementById('dateSearch')?.value || '';
            filterAndDisplayPredictions(searchDate);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      });
    }

    // Display a page of predictions
    function displayPredictionsPage(predictions, page) {
      const tbody = document.getElementById('predictionHistory');
      if (!tbody) return;

      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedPredictions = predictions.slice(start, end);

      if (paginatedPredictions.length === 0) {
        const colspan = bulkSelectMode ? 6 : 5;
        tbody.innerHTML = `
          <tr>
            <td colspan="${colspan}" class="text-center py-4">
              <div class="text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No predictions found
              </div>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = paginatedPredictions.map(prediction => {
        // Format the date
        const predictionDate = prediction.created_at || new Date().toISOString();
        const formattedDate = new Date(predictionDate).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Determine status
        const hasLocust = prediction.prediction_result === 1 || prediction.prediction_result === '1';
        const statusClass = hasLocust ? 'bg-danger' : 'bg-success';
        const statusText = hasLocust ? 'Locust Present' : 'No Locust';

        // Add checkbox cell if in bulk select mode
        const checkboxCell = bulkSelectMode ? `
          <td>
            <input type="checkbox" class="table-checkbox prediction-checkbox" 
                   data-id="${prediction.id}" 
                   onchange="handleCheckboxChange(this)"
                   ${selectedPredictions.has(prediction.id) ? 'checked' : ''}>
          </td>
        ` : '';

        return `
          <tr>
            ${checkboxCell}
            <td>${formattedDate}</td>
            <td>${prediction.region_name || 'N/A'}</td>
            <td>${prediction.country_name || 'N/A'}</td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary view-prediction" data-id="${prediction.id}">
                <i class="bi bi-eye me-1"></i>View
              </button>
              <button class="btn btn-sm btn-outline-danger delete-prediction" data-id="${prediction.id}">
                <i class="bi bi-trash me-1"></i>Delete
              </button>
            </td>
          </tr>`;
      }).join('');

      // Reattach event listeners to action buttons
      document.querySelectorAll('.delete-prediction').forEach(btn => {
        btn.addEventListener('click', handleDeletePrediction);
      });

      // Add event listeners to view buttons
      document.querySelectorAll('.view-prediction').forEach(btn => {
        btn.addEventListener('click', handleViewPrediction);
      });
    }

    // Update statistics cards
    function updateStatistics(predictions) {
      const total = predictions.length;
      const locustPresent = predictions.filter(p => p.prediction_result === 1 || p.prediction_result === '1').length;
      const noLocust = total - locustPresent;
      const detectionRate = total > 0 ? ((locustPresent / total) * 100).toFixed(1) : 0;

      document.getElementById('totalPredictions').textContent = total;
      document.getElementById('locustDetected').textContent = locustPresent;
      document.getElementById('noLocust').textContent = noLocust;
      document.getElementById('detectionRate').textContent = detectionRate + '%';
    }

    // Initialize charts
    function initializeCharts() {
      // Timeline chart
      const timelineCtx = document.getElementById('timelineChart').getContext('2d');
      timelineChart = new Chart(timelineCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Predictions',
            data: [],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });

      // Regional distribution chart
      const regionCtx = document.getElementById('regionChart').getContext('2d');
      regionChart = new Chart(regionCtx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [
              'rgba(255, 99, 132, 0.8)',
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 205, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 159, 64, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Update charts with data
    function updateCharts(predictions) {
      // Update timeline chart
      const monthlyData = {};
      predictions.forEach(p => {
        const date = new Date(p.created_at);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      timelineChart.data.labels = sortedMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      });
      timelineChart.data.datasets[0].data = sortedMonths.map(m => monthlyData[m]);
      timelineChart.update();

      // Update regional chart
      const regionalData = {};
      predictions.forEach(p => {
        const region = p.region_name || 'Unknown';
        regionalData[region] = (regionalData[region] || 0) + 1;
      });

      regionChart.data.labels = Object.keys(regionalData);
      regionChart.data.datasets[0].data = Object.values(regionalData);
      regionChart.update();
    }

    // Populate filter dropdowns
    function populateFilterDropdowns(predictions) {
      const regions = [...new Set(predictions.map(p => p.region_name).filter(r => r))];
      const countries = [...new Set(predictions.map(p => p.country_name).filter(c => c))];

      const regionFilter = document.getElementById('regionFilter');
      const countryFilter = document.getElementById('countryFilter');

      regions.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionFilter.appendChild(option);
      });

      countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilter.appendChild(option);
      });
    }

    // Apply filters
    function applyFilters() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const region = document.getElementById('regionFilter').value;
      const country = document.getElementById('countryFilter').value;
      const status = document.getElementById('statusFilter').value;

      filteredPredictions = allPredictions.filter(p => {
        // Date range filter
        if (startDate || endDate) {
          const predDate = new Date(p.created_at).toISOString().split('T')[0];
          if (startDate && predDate < startDate) return false;
          if (endDate && predDate > endDate) return false;
        }

        // Region filter
        if (region && p.region_name !== region) return false;

        // Country filter
        if (country && p.country_name !== country) return false;

        // Status filter
        if (status !== '') {
          const hasLocust = p.prediction_result === 1 || p.prediction_result === '1';
          if (status === '1' && !hasLocust) return false;
          if (status === '0' && hasLocust) return false;
        }

        return true;
      });

      currentPage = 1;
      updatePagination(filteredPredictions);
      displayPredictionsPage(filteredPredictions, currentPage);
      updateStatistics(filteredPredictions);
      updateCharts(filteredPredictions);
    }

    // Clear filters
    function clearFilters() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('regionFilter').value = '';
      document.getElementById('countryFilter').value = '';
      document.getElementById('statusFilter').value = '';
      applyFilters();
    }

    // Export to CSV
    function exportToCSV() {
      const data = filteredPredictions.length > 0 ? filteredPredictions : allPredictions;
      
      if (data.length === 0) {
        Swal.fire('No Data', 'No predictions to export', 'info');
        return;
      }

      const headers = ['Date', 'Region', 'Country', 'Year', 'Month', 'Temperature', 'Precipitation', 'Soil Moisture', 'Locust Present'];
      const rows = data.map(p => [
        new Date(p.created_at).toLocaleDateString(),
        p.region_name || 'N/A',
        p.country_name || 'N/A',
        p.start_year || 'N/A',
        p.start_month || 'N/A',
        p.temperature_celsius || 'N/A',
        p.precipitation_mm || 'N/A',
        p.soil_moisture_percent || 'N/A',
        p.prediction_result === 1 || p.prediction_result === '1' ? 'Yes' : 'No'
      ]);

      let csvContent = headers.join(',') + '\n';
      rows.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
      });

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `locust_predictions_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Export to PDF
    function exportToPDF() {
      const data = filteredPredictions.length > 0 ? filteredPredictions : allPredictions;
      
      if (data.length === 0) {
        Swal.fire('No Data', 'No predictions to export', 'info');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Add title
      doc.setFontSize(20);
      doc.text('Locust Prediction Report', 14, 22);

      // Add date
      doc.setFontSize(12);
      doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 32);

      // Add statistics
      const total = data.length;
      const locustPresent = data.filter(p => p.prediction_result === 1 || p.prediction_result === '1').length;
      const detectionRate = ((locustPresent / total) * 100).toFixed(1);

      doc.text(`Total Predictions: ${total}`, 14, 42);
      doc.text(`Locust Detected: ${locustPresent}`, 14, 50);
      doc.text(`Detection Rate: ${detectionRate}%`, 14, 58);

      // Add table
      const tableData = data.map(p => [
        new Date(p.created_at).toLocaleDateString(),
        p.region_name || 'N/A',
        p.country_name || 'N/A',
        p.prediction_result === 1 || p.prediction_result === '1' ? 'Yes' : 'No'
      ]);

      doc.autoTable({
        head: [['Date', 'Region', 'Country', 'Locust Present']],
        body: tableData,
        startY: 70,
        theme: 'striped'
      });

      doc.save(`locust_report_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // Toggle bulk select mode
    function toggleBulkSelect() {
      bulkSelectMode = !bulkSelectMode;
      const checkboxHeaders = document.querySelectorAll('.bulk-select-header');
      const bulkActionsDiv = document.getElementById('bulkActions');
      
      if (bulkSelectMode) {
        // Show checkboxes
        checkboxHeaders.forEach(header => header.style.display = 'table-cell');
        
        // Update button text
        event.target.innerHTML = '<i class="bi bi-x-square"></i> Cancel Selection';
        event.target.classList.remove('btn-outline-primary');
        event.target.classList.add('btn-outline-secondary');
        
        // Clear any previous selections
        selectedPredictions.clear();
        updateBulkActionsUI();
        
        // Re-render the table with checkboxes
        displayPredictionsPage(filteredPredictions.length > 0 ? filteredPredictions : allPredictions, currentPage);
      } else {
        // Hide checkboxes
        checkboxHeaders.forEach(header => header.style.display = 'none');
        bulkActionsDiv.classList.remove('show');
        
        // Update button text
        event.target.innerHTML = '<i class="bi bi-check-square"></i> Select Multiple';
        event.target.classList.remove('btn-outline-secondary');
        event.target.classList.add('btn-outline-primary');
        
        // Clear selections
        selectedPredictions.clear();
        
        // Re-render the table without checkboxes
        displayPredictionsPage(filteredPredictions.length > 0 ? filteredPredictions : allPredictions, currentPage);
      }
    }

    // Toggle select all checkboxes
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.prediction-checkbox');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        const predictionId = parseInt(checkbox.dataset.id);
        
        if (selectAllCheckbox.checked) {
          selectedPredictions.add(predictionId);
        } else {
          selectedPredictions.delete(predictionId);
        }
      });
      
      updateBulkActionsUI();
    }

    // Handle individual checkbox selection
    function handleCheckboxChange(checkbox) {
      const predictionId = parseInt(checkbox.dataset.id);
      
      if (checkbox.checked) {
        selectedPredictions.add(predictionId);
      } else {
        selectedPredictions.delete(predictionId);
      }
      
      // Update select all checkbox state
      const allCheckboxes = document.querySelectorAll('.prediction-checkbox');
      const selectAllCheckbox = document.getElementById('selectAll');
      selectAllCheckbox.checked = selectedPredictions.size === allCheckboxes.length && allCheckboxes.length > 0;
      
      updateBulkActionsUI();
    }

    // Update bulk actions UI
    function updateBulkActionsUI() {
      const bulkActionsDiv = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      
      selectedCount.textContent = selectedPredictions.size;
      
      if (selectedPredictions.size > 0) {
        bulkActionsDiv.classList.add('show');
      } else {
        bulkActionsDiv.classList.remove('show');
      }
    }

    // Bulk delete selected predictions
    async function bulkDelete() {
      if (selectedPredictions.size === 0) {
        Swal.fire('No Selection', 'Please select predictions to delete', 'info');
        return;
      }
      
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: `You are about to delete ${selectedPredictions.size} prediction(s). This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete them!',
        cancelButtonText: 'Cancel'
      });
      
      if (result.isConfirmed) {
        // Show loading
        Swal.fire({
          title: 'Deleting...',
          text: 'Please wait while we delete the selected predictions',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        let successCount = 0;
        let failCount = 0;
        
        // Delete each selected prediction
        for (const predictionId of selectedPredictions) {
          try {
            await api.predictions.delete(predictionId);
            successCount++;
          } catch (error) {
            console.error(`Failed to delete prediction ${predictionId}:`, error);
            failCount++;
          }
        }
        
        // Show result
        if (failCount === 0) {
          Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: `Successfully deleted ${successCount} prediction(s).`,
            timer: 2000
          });
        } else {
          Swal.fire({
            icon: 'warning',
            title: 'Partial Success',
            text: `Deleted ${successCount} prediction(s). Failed to delete ${failCount} prediction(s).`
          });
        }
        
        // Reset bulk select mode and reload data
        bulkSelectMode = false;
        selectedPredictions.clear();
        document.querySelector('[onclick="toggleBulkSelect()"]').click();
        await loadUserPredictions();
      }
    }

    // Export selected predictions
    function exportSelected() {
      if (selectedPredictions.size === 0) {
        Swal.fire('No Selection', 'Please select predictions to export', 'info');
        return;
      }
      
      // Filter predictions to only selected ones
      const selectedData = allPredictions.filter(p => selectedPredictions.has(p.id));
      
      if (selectedData.length === 0) {
        Swal.fire('Error', 'Could not find selected predictions', 'error');
        return;
      }
      
      // Export as CSV
      const headers = ['Date', 'Region', 'Country', 'Year', 'Month', 'Temperature', 'Precipitation', 'Soil Moisture', 'Locust Present'];
      const rows = selectedData.map(p => [
        new Date(p.created_at).toLocaleDateString(),
        p.region_name || 'N/A',
        p.country_name || 'N/A',
        p.start_year || 'N/A',
        p.start_month || 'N/A',
        p.temperature_celsius || 'N/A',
        p.precipitation_mm || 'N/A',
        p.soil_moisture_percent || 'N/A',
        p.prediction_result === 1 || p.prediction_result === '1' ? 'Yes' : 'No'
      ]);
      
      let csvContent = headers.join(',') + '\n';
      rows.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `selected_predictions_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      Swal.fire({
        icon: 'success',
        title: 'Export Complete',
        text: `Successfully exported ${selectedData.length} prediction(s)`,
        timer: 2000
      });
    }
    
  </script>

</body>

</html> 